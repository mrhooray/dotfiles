#!/usr/bin/env bash
DOTFILES=$HOME/.dotfiles
XDG_CONFIG_HOME=$HOME/.config

if [ ! -d $DOTFILES ]; then
    git clone https://github.com/mrhooray/dotfiles.git $DOTFILES
fi

for i in $(find $DOTFILES -mindepth 1 -maxdepth 1 ! -path '*.git' ! -path '*.gitignore' -iname '.*'); do
    target="$HOME/$(basename $i)"
    if [ -e "$target" ]; then
        echo "Skipping: $target (already exists)"
    else
        echo "Linking: $i -> $target"
        ln -sf $i "$target"
    fi
done

mkdir -p $XDG_CONFIG_HOME
for i in $(find $DOTFILES/config -mindepth 1 -maxdepth 1 -iname '*'); do
    target="$XDG_CONFIG_HOME/$(basename $i)"
    if [ -e "$target" ]; then
        echo "Skipping: $target (already exists)"
    else
        echo "Linking: $i -> $target"
        ln -sf $i "$target"
    fi
done

agents_md() {
    local base_dir=$1
    shift
    local agents=("$@")

    for agent in "${agents[@]}"; do
        mkdir -p "$base_dir/$agent"
        target="$base_dir/$agent/AGENTS.md"
        if [ -e "$target" ]; then
            echo "Skipping: $target (already exists)"
        else
            echo "Linking: $DOTFILES/AGENTS.md -> $target"
            ln -sf $DOTFILES/AGENTS.md "$target"
        fi
    done
}

agents_md "$XDG_CONFIG_HOME" "opencode" "amp"
agents_md "$HOME" ".claude" ".codex"

claude_md="$HOME/.claude/CLAUDE.md"
if [ -e "$claude_md" ]; then
    echo "Skipping: $claude_md (already exists)"
else
    echo "Linking: $HOME/.claude/AGENTS.md -> $claude_md"
    ln -sf AGENTS.md "$claude_md"
fi
